"use strict";(self["webpackChunkblog"]=self["webpackChunkblog"]||[]).push([[596],{596:function(s,a,n){n.r(a),n.d(a,{default:function(){return i}});var e=n(3396);const o={class:"content"},t=(0,e.uE)('<h1 class="post-title">记一次奇怪的 MySQL 错误解决<a class="header-anchor" id="%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A5%87%E6%80%AA%E7%9A%84%20MySQL%20%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3" href="#%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A5%87%E6%80%AA%E7%9A%84%20MySQL%20%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3">#</a></h1><div class="metabar"><div class="metabar-item">2021/08/06</div><div class="metabar-item">记录</div><div class="metabar-item">约 5 分钟读完</div></div><p>今天部署一个 PHP 后端的时候，发现在本地（Windows）测试可以连上数据库，而在生产环境（Ubuntu 20.04）上却报 Permission denied 错误，密码都是正确的，看来还是 Ubuntu 的安全弄得好哟😅，随便去 Google 了一下发现如果要用 root 登录必须得加上 <code>sudo</code>？太奇妙了，于是一秒想到去创建一个新的用户。</p><p><em>错误大概是这样的，一个很平凡的 Access denied。</em></p><div class="language-log"><pre class="language-log"><code class="language-log"><span class="token operator">(</span>HY000<span class="token operator">/</span><span class="token number">1698</span><span class="token operator">)</span><span class="token operator">:</span> Access denied for user <span class="token string">&#39;root&#39;</span><span class="token operator">@</span><span class="token string">&#39;localhost&#39;</span>\n</code></pre></div><p>然后我就去创建新的用户了，具体流程老生常谈了</p><div class="language-sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">&#39;rootp&#39;</span><span class="token variable">@&#39;localhost&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;...&#39;</span><span class="token punctuation">;</span> <span class="token comment">-- 不是 root 就可以，嘻嘻</span>\n<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;rootp&#39;</span><span class="token variable">@&#39;localhost&#39;</span><span class="token punctuation">;</span>\nFLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>\n</code></pre></div><p>然后就离开了数据库。就在这个时候我突然不知道怎么想的想要重启一下数据库，虽然这种情况下不重启是完全可以的。重启就重启吧，反正不是甚么高危操作，可这一重启可给爷整麻了啊，出现了我从来没有见过的错误，甚至觉得 MariaDB 在逗我。报错信息大概是这样的：</p><div class="language-log"><pre class="language-log"><code class="language-log"><span class="token date number">Aug 06</span> <span class="token time number">01:35:42</span> server systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> Starting MariaDB <span class="token number">10.1.47</span> database server<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">-</span><span class="token operator">-</span> Subject<span class="token operator">:</span> Unit <span class="token domain constant">mariadb.service</span> has begun start<span class="token operator">-</span>up\n<span class="token operator">-</span><span class="token operator">-</span> Defined<span class="token operator">-</span>By<span class="token operator">:</span> systemd\n<span class="token operator">-</span><span class="token operator">-</span> Support<span class="token operator">:</span> <span class="token url">http://www.ubuntu.com/support</span>\n<span class="token operator">-</span><span class="token operator">-</span>\n<span class="token operator">-</span><span class="token operator">-</span> Unit <span class="token domain constant">mariadb.service</span> has begun starting up<span class="token punctuation">.</span>\n<span class="token date number">Aug 06</span> <span class="token time number">01:35:43</span> server mysqld<span class="token punctuation">[</span><span class="token number">4431</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token date number">2021-08-06</span>  <span class="token time number">1:35:43</span> <span class="token number">140103940127872</span> <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> <span class="token file-path string">/usr/sbin/mysqld</span> <span class="token operator">(</span>mysqld <span class="token number">10.1.47</span><span class="token operator">-</span>MariaDB<span class="token operator">-</span>0ubuntu0<span class="token punctuation">.</span>18<span class="token punctuation">.</span>04<span class="token punctuation">.</span>1<span class="token operator">)</span> starting as process <span class="token number">4431</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token date number">Aug 06</span> <span class="token time number">01:35:46</span> server systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> mariadb<span class="token punctuation">.</span>service<span class="token operator">:</span> Main process exited<span class="token punctuation">,</span> code<span class="token operator">=</span>exited<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">7</span><span class="token operator">/</span>NOTRUNNING\n<span class="token date number">Aug 06</span> <span class="token time number">01:35:46</span> server systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> mariadb<span class="token punctuation">.</span>service<span class="token operator">:</span> Failed with result <span class="token string">&#39;exit-code&#39;</span><span class="token punctuation">.</span>\n<span class="token date number">Aug 06</span> <span class="token time number">01:35:46</span> server systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> Failed to start MariaDB <span class="token number">10.1.47</span> database server<span class="token punctuation">.</span>\n<span class="token operator">-</span><span class="token operator">-</span> Subject<span class="token operator">:</span> Unit <span class="token domain constant">mariadb.service</span> has failed\n<span class="token operator">-</span><span class="token operator">-</span> Defined<span class="token operator">-</span>By<span class="token operator">:</span> systemd\n<span class="token operator">-</span><span class="token operator">-</span> Support<span class="token operator">:</span> <span class="token url">http://www.ubuntu.com/support</span>\n<span class="token operator">-</span><span class="token operator">-</span>\n<span class="token operator">-</span><span class="token operator">-</span> Unit <span class="token domain constant">mariadb.service</span> has failed<span class="token punctuation">.</span>\n<span class="token operator">-</span><span class="token operator">-</span>\n<span class="token operator">-</span><span class="token operator">-</span> The result is RESULT<span class="token punctuation">.</span>\n</code></pre></div><p>看看高亮的行，说的是 SQL 话吗？啥叫作 <code>Failed with result &#39;exit-code&#39;</code>、<code>The result is RESULT</code>？笑死，听君一席话，如听一席话！无论怎么去查，得到的结果都不是完全符合，但是它们都有一个共性就是——你要重装你的 MySQL。确实，重装是一个完美的办法，我也很喜欢，干脆利落不用费事费力想办法，可是——我的数据！MySQL 死了，所以 <code>mysqldump</code> 也用不了...这是个悖论，我的数据可能取不回来了，那真是够恐怖。但是我忽然又想到，MySQL 一定是通过文件来存储数据的，于是我搜到了下面这段话。</p><blockquote><p>What you should do is image your drive, copy it to something else, in preparation for your reinstall. I&#39;d recommend copying everything as authentically as you can, even if that takes a while. That feeling you get when you realize you forgot to salvage something important that is now gone forever is not good.</p><p>MySQL generally stores data in the data directory. It may take some work to get your MySQL back into the same configuration as before, so be sure to grab the appropriate my.cnf file.</p><p>It can be really difficult to extract data from a bunch of MySQL data files without the MySQL process actually running. This is why tools like mysqldump exist. If you can get it running, even limping along, that&#39;ll be good enough to snapshot it. <br><br><em>来自 <a href="https://stackoverflow.com/questions/20130706/backup-dead-mysql-server" class="external-link" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/20130706/backup-dead-mysql-server<span class="external-link-icon mdi mdi-launch"></span></a></em></p></blockquote><p>这段话告诉我，将来的路会很坎坷...啊这，我只是想要重启个 MySQL，用得着这样对我吗。束手无策的时候，我突然想到，既然要重装，要不把数据都换个位置试试？也就是说把整个 MySQL 用来存放数据的文件夹换到另外一个地方，嗯，换个新的环境，没准就可以了。就是这个奇妙的脑回路拯救了我。</p><p>首先，遇到了一个很坑的地方，那就是不确定数据在哪里。网上说的默认在 <code>/var/lib/mysql</code>，虽然我也发现那里有很多文件，也是不敢确定。然后又有的说可以在配置文件 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> 里面看，结果并没有这个文件，也许是因为我是 MariaDB，所以应该在 <code>/etc/mysql/my.cnf</code> 里面。确实有这个文件，但是里面并没有 <code>datadir</code> 这个参数，真是醉了。到后来我鼓起勇气把 <code>datadir</code> 设置成了 <code>/mysql-db</code>，开始了迁移之路。</p><div class="language-shell"><pre class="language-shell"><code class="language-shell"><span class="token function">mkdir</span> /mysql-db\n<span class="token function">rsync</span> <span class="token parameter variable">-av</span> /var/lib/mysql/ /mysql-db\n<span class="token function">chmod</span> <span class="token number">755</span> /mysql-db\n</code></pre></div><p>盘点一下这里的坑，首先 <code>rsync</code> 的第二个参数 <code>/var/lib/mysql/</code> 的最后带不带 <code>/</code> 是有区别的。带上了就代表 <code>/var/lib/mysql/*</code>，不带上就代表这个目录本身。刚开始没有带，复制了以后也没有去 <code>ls /mysql-db</code> 导致启动的时候刷了一大堆 not found 报错...然后就是权限问题，应该是 <code>755</code>。</p><div class="notice tip"><p>为啥不用 <code>mv *</code>？因为当时想不到 <code>mv</code>，别骂了</p></div><p>然后还有一个点就是要去 apparmor 里面创建一个别名。</p><div class="language-shell"><pre class="language-shell"><code class="language-shell"><span class="token function">vim</span> /etc/apparmor.d/tunables/alias\n</code></pre></div><p>添加 <code>alias /var/lib/mysql -&gt; /mysql-db</code>，然后 <code>systemctl restart apparmor</code>。接下来就可以准备启动 MySQL 了。</p><div class="language-shell"><pre class="language-shell"><code class="language-shell">systemctl start mysql\n</code></pre></div><p>让我震惊的是这次启动没有报错了。原理还待解释，不过我一秒就去全量备份了一下，因为有了备份就可以直接重装就没有这么多破事了😅</p><div class="language-shell"><pre class="language-shell"><code class="language-shell">mysqldump <span class="token parameter variable">-u</span> root --all-databases <span class="token operator">&gt;</span> /alldb.sql\n</code></pre></div><p>然后还可以在 cron 里面加一个定时的备份，为了避免输入密码，可以创建一个 <code>~/my.cnf</code> 然后写入内容</p><div class="language-ini"><pre class="language-ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqldump</span><span class="token punctuation">]</span></span>\n<span class="token key attr-name">user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>\n<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">...</span>\n</code></pre></div><p>然后在 <code>crontab -e</code> 里面加入</p><div class="language-plaintext"><pre class="language-plaintext"><code class="language-plaintext">10 * * * * mysqldump -u root --all-databases &gt; /alldb.sql\n</code></pre></div><p>就可以了。</p>',27),p=[t];function c(s,a){return(0,e.wg)(),(0,e.iD)("div",o,p)}var l=n(89);const r={},u=(0,l.Z)(r,[["render",c]]);var i=u}}]);
//# sourceMappingURL=596.b630643a.js.map